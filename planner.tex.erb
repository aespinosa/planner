\setuppapersize[A6][A6]
\setuppagenumbering[state=stop]

\def\translate{}

\def\stripzero#1{\expandafter\stripzerohelp#1}
\def\stripzerohelp#1{\ifx 0#1\expandafter\stripzerohelp\else#1\fi}

\setupcolors[state=start]

\starttext

Planner 2016

\page[yes]
\switchtobodyfont[6pt]
<% 3.upto(5) do |month| %>

\setupTABLE[c][each][width=0.25\textwidth]
\setupTABLE[row][2,3,4,5,6,7,8][height=\dimexpr \textheight / 6\relax]
<% Date.new(2016, month, 1).upto(Date.new(2016, month, -1)) do |date| %>
  <% if date.day == 1 && !date.monday? %>
\bTABLE

\bTABLEhead
\bTR
  \bTH Weekly Plan \eTH
  \bTH Monday \eTH
  \bTH Tuesday \eTH
  \bTH Wednesday \eTH
\eTR
\eTABLEhead
\bTABLEbody

  \bTR
    <% [(date.wday + 1) % 7, 2].min.times do %>
    \bTD memo \eTD
      <% end %>
  \eTR
  <% end %>
  <% if date.monday? %>
  \bTR \bTD \eTD
  <% end %>
  <% if date.monday? || date.tuesday? || date.wednesday? %>
  \bTD <%= date.day %>\eTD
  <% end %>
  <% if date.wednesday? %>
  \eTR
  <% end %>
  <% if date.day == Date.new(date.year, date.month, -1).day && date.wday < 4 %>
    <% (date.wday - 1).times do %>
    \bTD x \eTD
    <% end %>
  \eTR
  <% end %>
  <% if date.day == Date.new(date.year, date.month, -1).day && date.cweek - Date.new(date.year, date.month, 1).cweek < 5 %>
  \bTR \bTD[nc=4] memo \eTD \eTR
  <% end %>
<% end %>

\eTABLEbody
\eTABLE


\page[yes]
<% Date.new(2016, month, 1).upto(Date.new(2016, month, -1)) do |date| %>
  <% if date.day == 1 && !date.monday? %>
\bTABLE
\setupTABLE[col][each][width=\dimexpr \textwidth / 4\relax]

\bTABLEhead
\bTR
  \bTH Thursday \eTH
  \bTH Friday \eTH
  \bTH Saturday \eTH
  \bTH Sunday \eTH
\eTR
\eTABLEhead
\bTABLEbody

  \bTR
    <% ((date.wday + 6) % 7 - 3).times  do %>
    \bTD x \eTD
      <% end %>
  \eTR
  <% end %>
  <% if date.monday? %>
  \bTR 
  <% end %>
  <% if date.thursday? || date.friday? || date.saturday? || date.sunday? %>
    \bTD <%= date.day %>\eTD
  <% end %>
  <% if date.day == Date.new(date.year, date.month, -1).day && !date.sunday? %>
    <% [(7 - date.wday), 4].min.times do %>
    \bTD x \eTD
    <% end %>
  \eTR
  <% end %>
  <% if date.sunday? %>
  \eTR
  <% end %>
  <% if date.day == Date.new(date.year, date.month, -1).day && date.cweek - Date.new(date.year, date.month, 1).cweek < 5 %>
  \bTR \bTD[nc=4] memo \eTD \eTR
  <% end %>
<% end %>

\eTABLEbody
\eTABLE

\page[yes]

<% end %>

<% Date.new(2016, 2, -1).upto(Date.new(2016, 3, -1)) do |date| %>
  <% if date.monday? %>
    \setupheadertexts[
      <%= date.month %>
      <%= date.to_time.strftime('%b') %>
    ]
    \hrule

    notes and a month calendar
    \vfill

    \hrule
  <% end %>
  <% if date.thursday? %>
    \setupheadertexts[<%= date.year %>]
    \hrule
  <% end %>

    \blank[line]
    <%= date.day %>
    <%= date.to_time.strftime('%a') %>
    \vfill
    \hrule

  <% if date.sunday? || date.wednesday? %>
    \page[yes]
  <% end %>
<% end %>

\stoptext
